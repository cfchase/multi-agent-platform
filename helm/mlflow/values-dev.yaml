# MLFlow Helm Chart Values for Development
# Chart: community-charts/mlflow
# https://community-charts.github.io/docs/charts/mlflow/usage

replicaCount: 1

# Backend store - PostgreSQL
backendStore:
  databaseMigration: true
  postgres:
    enabled: true
    host: postgres
    port: 5432
    database: mlflow
    # user and password set via --set flags from postgres-secret

# Artifact storage - local PVC (simple for dev)
artifactRoot:
  proxiedArtifactStorage: true

# Resources
resources:
  requests:
    memory: "512Mi"
    cpu: "250m"
  limits:
    memory: "1Gi"
    cpu: "500m"

# Service
service:
  type: ClusterIP
  port: 5000
  containerPort: 5000

# Disable built-in auth - OAuth proxy handles authentication
auth:
  enabled: false

# Disable ingress - we use OpenShift Route
ingress:
  enabled: false

# Allow any host header (required for OpenShift routes)
# See: https://mlflow.org/docs/latest/self-hosting/
extraArgs:
  host: "0.0.0.0"

extraEnvVars:
  # Allow all hosts for OpenShift route access (required for routes)
  # See: https://mlflow.org/docs/latest/self-hosting/security/network/
  MLFLOW_SERVER_ALLOWED_HOSTS: "*"
  MLFLOW_ALLOW_ORIGINS: "*"

# OpenShift compatibility - do not specify UIDs, let SCC assign them
podSecurityContext: {}

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  capabilities:
    drop:
      - ALL

# Use shared ServiceAccount for OAuth proxy
serviceAccount:
  create: false
  name: "supporting-services-proxy"

# OAuth proxy sidecar for OpenShift authentication
extraContainers:
  - name: oauth-proxy
    image: quay.io/openshift/origin-oauth-proxy:4.17
    imagePullPolicy: IfNotPresent
    ports:
      - name: oauth-proxy
        containerPort: 4180
        protocol: TCP
    args:
      - -provider=openshift
      - -http-address=:4180
      - -https-address=
      - -email-domain=*
      - -upstream=http://localhost:5000
      - -cookie-secure=false
      - -cookie-secret-file=/etc/proxy/secrets/session_secret
      - -openshift-service-account=supporting-services-proxy
      - -openshift-ca=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      - -openshift-sar={"namespace":"NAMESPACE_PLACEHOLDER","resource":"pods","verb":"update"}
    volumeMounts:
      - name: proxy-session-secret
        mountPath: /etc/proxy/secrets
        readOnly: true
    resources:
      requests:
        memory: "32Mi"
        cpu: "25m"
      limits:
        memory: "64Mi"
        cpu: "50m"

# Volume for OAuth proxy session secret
extraVolumes:
  - name: proxy-session-secret
    secret:
      secretName: supporting-services-proxy-session
